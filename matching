import discord
from discord.ext import commands
from discord import app_commands
import os
import random
from dotenv import load_dotenv
import asyncio
import datetime
from typing import Dict, Set, Tuple, List

# --- Environment Variables ---
load_dotenv()
TOKEN = os.getenv('DISCORD_TOKEN')

# --- Configuration ---
SOURCE_CHANNEL_GIRLS_NAME = "å¥³å­å›ç­”"
SOURCE_CHANNEL_BOYS_NAME = "ç”·å­å›ç­”"
TARGET_CHANNEL_GIRLS_NAME = "å¥³å­é¸æŠ"
TARGET_CHANNEL_BOYS_NAME = "ç”·å­é¸æŠ"

# Role IDs for users allowed to react/select
ALLOWED_ROLE_IDS: Set[int] = {
    1106457108070801449,  # ä¾‹: ç”·å­ç”¨ãƒ­ãƒ¼ãƒ«ID
    1304664940019187762   # ä¾‹: å¥³å­ç”¨ãƒ­ãƒ¼ãƒ«ID
}

# Role ID allowed to execute /send1, /match, /reset etc.
EXECUTE_ROLE_ID = 991112832655560825  # ä¾‹: ç®¡ç†è€…ç”¨å½¹è·ID

# Voice Channel IDs for matched pairs
VOICE_CHANNEL_IDS = [
    861209035901501451, 921389966939000842, 861209625353650176, 1144961582158315601,
    1346803272094191616, 1144961845891969086, 1346803325705916470, 1030459649952055326,
    861209735826898954, 889128948225679410, 1124346578522607667, 1076820944896675931,
    1129391099354546249, 1129391139905097768, 1165525003165515847, 1165611161887191070,
    1165525074317676615, 1165606798577901648, 1165606801547464765, 1165606820178567220,
    1165606757788307506, 1238860655683960853,
]

# Waiting Voice Channel ID (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã™ã‚‹éš›ã®å¾…æ©ŸVC)
WAITING_VOICE_CHANNEL_ID = 1059809361645551746

# --- Bot Setup ---
intents = discord.Intents.default()
intents.messages = True
intents.guilds = True
intents.message_content = True
intents.reactions = True
intents.members = True

bot = commands.Bot(command_prefix="!", intents=intents)

# --- Global State Variables ---
source_channel_girls: discord.TextChannel = None
source_channel_boys: discord.TextChannel = None
target_channel_girls: discord.TextChannel = None
target_channel_boys: discord.TextChannel = None
forwarded_message_ids: Dict[int, Set[int]] = {}
message_map: Dict[int, Tuple[int, int, int]] = {}  # {original_message_id: (forwarded_message_id, destination_channel_id, original_author_id)}
active_claimable_messages: Set[int] = set()
claimed_messages: Dict[int, int] = {}  # {forwarded_message_id: claimer_id}
users_who_claimed_this_round: Set[int] = set()
matched_pairs: Set[int] = set()
current_match_channel_index: int = 0
bot_start_time: datetime.datetime = None
last_non_winner_message_boys_id: int = None
last_non_winner_message_girls_id: int = None

# --- Custom Check ---
def allowed_role_check(interaction: discord.Interaction) -> bool:
    """EXECUTE_ROLE_IDã‚’æŒã¤äººã®ã¿å®Ÿè¡Œå¯"""
    return any(role.id == EXECUTE_ROLE_ID for role in interaction.user.roles)

# --- Utility Functions ---
async def post_list_message(channel: discord.TextChannel, content: str, old_message_id: int) -> Tuple[int, List[str]]:
    """
    æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã—ã€å­˜åœ¨ã—ãªã‘ã‚Œã°æ–°è¦é€ä¿¡ã™ã‚‹ã€‚
    æˆ»ã‚Šå€¤: (æœ€çµ‚çš„ã«å­˜åœ¨ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID, ã‚¨ãƒ©ãƒ¼ãƒªã‚¹ãƒˆ)
    """
    errors = []
    new_message_id = None
    if not channel:
        errors.append("ã‚¨ãƒ©ãƒ¼: å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return None, errors

    if old_message_id:
        try:
            old_msg = await channel.fetch_message(old_message_id)
            await old_msg.edit(content=content)
            new_message_id = old_msg.id
            return new_message_id, errors
        except discord.NotFound:
            pass
        except discord.Forbidden:
            errors.append(f"è­¦å‘Š: ãƒãƒ£ãƒ³ãƒãƒ« '{channel.name}' ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        except Exception as e:
            errors.append(f"ç·¨é›†æ™‚ã‚¨ãƒ©ãƒ¼({channel.name}): {e}")

    try:
        sent_msg = await channel.send(content)
        new_message_id = sent_msg.id
    except discord.Forbidden:
        errors.append(f"ã‚¨ãƒ©ãƒ¼: ãƒãƒ£ãƒ³ãƒãƒ« '{channel.name}' ã¸ã®é€ä¿¡æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
    except Exception as e:
        errors.append(f"é€ä¿¡æ™‚ã‚¨ãƒ©ãƒ¼({channel.name}): {e}")

    return new_message_id, errors

async def calculate_non_winner_content(guild: discord.Guild) -> Tuple[str, str, List[str]]:
    """
    æœªå½“é¸è€…ãƒªã‚¹ãƒˆã®å†…å®¹ã‚’è¨ˆç®—ã™ã‚‹ã€‚
    ã€Œæœªå½“é¸ã€ã‹ã¤ã€Œå¾…æ©ŸVCã«æ¥ç¶šã—ã¦ã„ã‚‹ã€ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿è¡¨ç¤ºã€‚
    """
    global target_channel_boys, target_channel_girls, message_map, claimed_messages
    calc_errors: List[str] = []

    role_girls_id = 1304664940019187762
    role_boys_id = 1106457108070801449

    role_girls = guild.get_role(role_girls_id)
    role_boys = guild.get_role(role_boys_id)

    winners_girls = set()
    winners_boys = set()

    for fwd_id, claimer_id in claimed_messages.items():
        original_author_id = None
        dest_channel_id = None
        found = False
        for _orig_id, (fwd_id_map, dest_channel_id_map, original_author_id_map) in message_map.items():
            if fwd_id_map == fwd_id:
                original_author_id = original_author_id_map
                dest_channel_id = dest_channel_id_map
                found = True
                break
        if not found:
            calc_errors.append(f"è»¢é€ID {fwd_id} ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
            continue

        if target_channel_boys and dest_channel_id == target_channel_boys.id:
            winners_boys.add(claimer_id)
            winners_girls.add(original_author_id)
        elif target_channel_girls and dest_channel_id == target_channel_girls.id:
            winners_girls.add(claimer_id)
            winners_boys.add(original_author_id)
        else:
            calc_errors.append(f"è»¢é€å…ˆãƒãƒ£ãƒ³ãƒãƒ«ID {dest_channel_id} ãŒä¸æ˜ã§ã™ã€‚")

    non_winners_boys = []
    if role_boys:
        for m in role_boys.members:
            if (m.id not in winners_boys
                and m.voice
                and m.voice.channel
                and m.voice.channel.id == WAITING_VOICE_CHANNEL_ID):
                non_winners_boys.append(m.mention)

    non_winners_girls = []
    if role_girls:
        for m in role_girls.members:
            if (m.id not in winners_girls
                and m.voice
                and m.voice.channel
                and m.voice.channel.id == WAITING_VOICE_CHANNEL_ID):
                non_winners_girls.append(m.mention)

    content_boys = "ã€ç”·å­ æœªå½“é¸è€…ä¸€è¦§ã€‘\n" + (", ".join(non_winners_boys) if non_winners_boys else "ãªã—")
    content_girls = "ã€å¥³å­ æœªå½“é¸è€…ä¸€è¦§ã€‘\n" + (", ".join(non_winners_girls) if non_winners_girls else "ãªã—")

    return content_boys, content_girls, calc_errors

# --- Bot Events ---
@bot.event
async def on_ready():
    global source_channel_girls, source_channel_boys
    global target_channel_girls, target_channel_boys
    global forwarded_message_ids, bot_start_time

    print(f'{bot.user.name} ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ (ID: {bot.user.id})')
    bot_start_time = datetime.datetime.now(datetime.timezone.utc)

    try:
        synced = await bot.tree.sync()
        print(f"{len(synced)}å€‹ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’åŒæœŸã—ã¾ã—ãŸã€‚")
    except Exception as e:
        print(f"ã‚³ãƒãƒ³ãƒ‰åŒæœŸã‚¨ãƒ©ãƒ¼: {e}")

    if not bot.guilds:
        print("ã‚¨ãƒ©ãƒ¼: å‚åŠ ã‚µãƒ¼ãƒãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        await bot.close()
        return

    guild = bot.guilds[0]
    source_channel_girls = discord.utils.get(guild.text_channels, name=SOURCE_CHANNEL_GIRLS_NAME)
    source_channel_boys = discord.utils.get(guild.text_channels, name=SOURCE_CHANNEL_BOYS_NAME)
    target_channel_girls = discord.utils.get(guild.text_channels, name=TARGET_CHANNEL_GIRLS_NAME)
    target_channel_boys = discord.utils.get(guild.text_channels, name=TARGET_CHANNEL_BOYS_NAME)

    if not all([source_channel_girls, source_channel_boys, target_channel_girls, target_channel_boys]):
        print("å¿…è¦ãªãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    else:
        forwarded_message_ids = {
            source_channel_girls.id: set(),
            source_channel_boys.id: set()
        }
    print("Botæº–å‚™å®Œäº†ã€‚")

@bot.event
async def on_message_edit(before: discord.Message, after: discord.Message):
    if before.author.bot or before.id not in message_map:
        return

    forwarded_message_id, destination_channel_id, _ = message_map[before.id]
    destination_channel = bot.get_channel(destination_channel_id)
    if not destination_channel or not isinstance(destination_channel, discord.TextChannel):
        return

    try:
        f_msg = await destination_channel.fetch_message(forwarded_message_id)
    except discord.NotFound:
        return
    except Exception as e:
        print(f"[on_message_edit] è»¢é€å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return

    new_content = after.content if after.content else "(æœ¬æ–‡ãªã—)"
    try:
        if f_msg.embeds:
            new_embed = f_msg.embeds[0].copy()
            new_embed.description = new_content
            await f_msg.edit(embed=new_embed)
        else:
            await f_msg.edit(content=new_content)
    except Exception as e:
        print(f"[on_message_edit] è»¢é€å…ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")

@bot.event
async def on_message_delete(message: discord.Message):
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id

    if message.author.bot or message.id not in message_map:
        return

    forwarded_message_id, destination_channel_id, _ = message_map.pop(message.id)
    destination_channel = bot.get_channel(destination_channel_id)

    active_claimable_messages.discard(forwarded_message_id)
    if forwarded_message_id in claimed_messages:
        claimer_id = claimed_messages.pop(forwarded_message_id)
        users_who_claimed_this_round.discard(claimer_id)
        matched_pairs.discard(forwarded_message_id)

    if destination_channel and isinstance(destination_channel, discord.TextChannel):
        try:
            f_msg = await destination_channel.fetch_message(forwarded_message_id)
            await f_msg.delete()
        except discord.NotFound:
            pass
        except Exception as e:
            print(f"[on_message_delete] è»¢é€å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã‚¨ãƒ©ãƒ¼: {e}")

    try:
        if message.guild:
            content_boys, content_girls, calc_errors = await calculate_non_winner_content(message.guild)
            if calc_errors:
                for err in calc_errors:
                    print(f"[on_message_delete] ãƒªã‚¹ãƒˆæ›´æ–°è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {err}")

            if target_channel_boys and any(v[1] == target_channel_boys.id for v in message_map.values()):
                new_id, errors = await post_list_message(target_channel_boys, content_boys, last_non_winner_message_boys_id)
                if new_id:
                    last_non_winner_message_boys_id = new_id
                for err in errors:
                    print(f"[on_message_delete] ç”·å­æœªå½“é¸ãƒªã‚¹ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: {err}")

            if target_channel_girls and any(v[1] == target_channel_girls.id for v in message_map.values()):
                new_id, errors = await post_list_message(target_channel_girls, content_girls, last_non_winner_message_girls_id)
                if new_id:
                    last_non_winner_message_girls_id = new_id
                for err in errors:
                    print(f"[on_message_delete] å¥³å­æœªå½“é¸ãƒªã‚¹ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: {err}")
    except Exception as e:
        print(f"[on_message_delete] æœªå½“é¸è€…ãƒªã‚¹ãƒˆå†æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")

@bot.event
async def on_raw_reaction_add(payload: discord.RawReactionActionEvent):
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id
    if payload.user_id == bot.user.id or str(payload.emoji) != 'ğŸ‘':
        return

    guild = bot.get_guild(payload.guild_id)
    if not guild: return
    channel = guild.get_channel(payload.channel_id)
    if not isinstance(channel, discord.TextChannel): return

    try:
        message = await channel.fetch_message(payload.message_id)
    except Exception as e:
        print(f"ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return

    member = payload.member or (await guild.fetch_member(payload.user_id))
    if payload.message_id not in active_claimable_messages: return

    if (
        payload.message_id in claimed_messages or
        payload.user_id in users_who_claimed_this_round or
        not (member.voice and member.voice.channel and member.voice.channel.id == WAITING_VOICE_CHANNEL_ID) or
        not any(role.id in ALLOWED_ROLE_IDS for role in member.roles)
    ):
        try: await message.remove_reaction(payload.emoji, member)
        except: pass
        return

    claimed_messages[payload.message_id] = payload.user_id
    users_who_claimed_this_round.add(payload.user_id)
    active_claimable_messages.remove(payload.message_id)

    try:
        await message.clear_reaction('ğŸ‘')
        await message.add_reaction('âœ…')
        if message.embeds:
            new_embed = message.embeds[0].copy()
            selector_index = -1
            for i, field in enumerate(new_embed.fields):
                if field.name == "é¸æŠè€…": selector_index = i; break
            if selector_index != -1:
                new_embed.set_field_at(selector_index, name="é¸æŠè€…", value=f"âœ… {member.mention}", inline=False)
            else:
                new_embed.add_field(name="é¸æŠè€…", value=f"âœ… {member.mention}", inline=False)
            await message.edit(embed=new_embed)
        else:
            await message.edit(content=message.content + f"\nâœ… {member.mention} ã•ã‚“ãŒé¸æŠã—ã¾ã—ãŸï¼")

        content_boys, content_girls, _ = await calculate_non_winner_content(guild)
        if target_channel_boys and any(v[1] == target_channel_boys.id for v in message_map.values()):
            new_id, _ = await post_list_message(target_channel_boys, content_boys, last_non_winner_message_boys_id)
            if new_id: last_non_winner_message_boys_id = new_id
        if target_channel_girls and any(v[1] == target_channel_girls.id for v in message_map.values()):
            new_id, _ = await post_list_message(target_channel_girls, content_girls, last_non_winner_message_girls_id)
            if new_id: last_non_winner_message_girls_id = new_id
    except Exception as e:
        print(f"ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
        claimed_messages.pop(payload.message_id, None)
        users_who_claimed_this_round.discard(payload.user_id)
        active_claimable_messages.add(payload.message_id)

# --- Slash Commands ---
@bot.tree.command(name="send1", description="å›ç­”ã‚’è»¢é€ã—ã€æœªå½“é¸è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°")
@app_commands.check(allowed_role_check)
async def send_messages(interaction: discord.Interaction):
    global forwarded_message_ids, message_map, active_claimable_messages, last_non_winner_message_boys_id, last_non_winner_message_girls_id
    if not all([source_channel_girls, source_channel_boys, target_channel_girls, target_channel_boys]):
        await interaction.response.send_message("ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªãƒãƒ£ãƒ³ãƒãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", ephemeral=True)
        return
    await interaction.response.defer(ephemeral=True)
    error_messages_list: List[str] = []
    
    async def process_channel(source_channel, target_channel, embed_color):
        count = 0
        try:
            source_messages = [
                msg async for msg in source_channel.history(limit=None, after=bot_start_time)
                if not msg.author.bot and msg.id not in forwarded_message_ids.get(source_channel.id, set()) and msg.id not in message_map and (msg.content or msg.attachments)
            ]
            random.shuffle(source_messages)
            for orig_msg in source_messages:
                try:
                    embed = discord.Embed(description=orig_msg.content if orig_msg.content else "(æœ¬æ–‡ãªã—)", color=embed_color, timestamp=orig_msg.created_at)
                    image_url = next((att.url for att in orig_msg.attachments if att.content_type and att.content_type.startswith('image/')), None)
                    if image_url:
                        embed.set_image(url=image_url)
                    others = [att.filename for att in orig_msg.attachments if att.url != image_url]
                    if others:
                        embed.add_field(name="æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«", value="\n".join(f"- {name}" for name in others), inline=False)
                    embed.add_field(name="é¸æŠè€…", value="ãªã—", inline=False)
                    fwd_msg = await target_channel.send(embed=embed)
                    await fwd_msg.add_reaction("ğŸ‘")
                    forwarded_message_ids[source_channel.id].add(orig_msg.id)
                    message_map[orig_msg.id] = (fwd_msg.id, target_channel.id, orig_msg.author.id)
                    active_claimable_messages.add(fwd_msg.id)
                    count += 1
                    await asyncio.sleep(0.5)
                except Exception as e:
                    error_messages_list.append(f"è»¢é€ä¸­ã‚¨ãƒ©ãƒ¼ (ID:{orig_msg.id}): {e}")
            return count
        except Exception as e:
            error_messages_list.append(f"{source_channel.name} å‡¦ç†ä¸­ã‚¨ãƒ©ãƒ¼: {e}")
            return count

    count_g = await process_channel(source_channel_girls, target_channel_boys, discord.Color.fuchsia())
    count_b = await process_channel(source_channel_boys, target_channel_girls, discord.Color.blue())
    total_forwarded_count = count_g + count_b

    if total_forwarded_count > 0 and interaction.guild:
        content_boys, content_girls, calc_errors = await calculate_non_winner_content(interaction.guild)
        error_messages_list.extend(calc_errors)
        if target_channel_boys and any(v[1] == target_channel_boys.id for v in message_map.values()):
            new_id, post_err = await post_list_message(target_channel_boys, content_boys, last_non_winner_message_boys_id)
            if new_id: last_non_winner_message_boys_id = new_id
            error_messages_list.extend(post_err)
        if target_channel_girls and any(v[1] == target_channel_girls.id for v in message_map.values()):
            new_id, post_err = await post_list_message(target_channel_girls, content_girls, last_non_winner_message_girls_id)
            if new_id: last_non_winner_message_girls_id = new_id
            error_messages_list.extend(post_err)
    
    result_msg = f"åˆè¨ˆ {total_forwarded_count} ä»¶ã®æ–°è¦è»¢é€å®Œäº†ã€‚"
    if error_messages_list:
        result_msg += "\nã‚¨ãƒ©ãƒ¼/è­¦å‘Š:\n" + "\n".join(f"- {msg}" for msg in error_messages_list)
    else:
        result_msg += "\næœªå½“é¸è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚"
    await interaction.followup.send(result_msg, ephemeral=True)

# ===================================================================
# â˜…â˜…â˜… /match ã‚³ãƒãƒ³ãƒ‰ï¼ˆguild.chunk å®Œå…¨å‰Šé™¤ç‰ˆï¼‰ â˜…â˜…â˜…
# ===================================================================
@bot.tree.command(name="match", description="ãƒšã‚¢ç§»å‹•ï¼†çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼†ãƒªã‚¹ãƒˆæ›´æ–°")
@app_commands.check(allowed_role_check)
async def match_all(interaction: discord.Interaction):
    """
    é¸æŠæ¸ˆã¿ãƒšã‚¢ã‚’ VC ã¸ç§»å‹•ã—ã€çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é«˜é€Ÿç‰ˆ
    â€» Guild.query_members(user_ids=â€¦) ã§ä¸€æ‹¬å–å¾—
    """
    # ---- ã‚°ãƒ­ãƒ¼ãƒãƒ« ----------------------------------------------------
    global current_match_channel_index, matched_pairs
    global forwarded_message_ids, message_map, active_claimable_messages
    global claimed_messages, users_who_claimed_this_round
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id
    global source_channel_girls, source_channel_boys, target_channel_boys, target_channel_girls

    await interaction.response.defer(ephemeral=True)
    guild: discord.Guild | None = interaction.guild
    if guild is None:
        await interaction.followup.send("ã‚µãƒ¼ãƒãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼", ephemeral=True)
        return

    # ---- 1. ãƒšã‚¢åé›† ---------------------------------------------------
    pairs: list[dict] = []
    need_ids: set[int] = set()
    logs: list[str]  = []

    for o_id, (fwd_id, dest_id, author_id) in list(message_map.items()):
        if fwd_id not in claimed_messages or fwd_id in matched_pairs:
            continue
        if current_match_channel_index >= len(VOICE_CHANNEL_IDS):
            logs.append("ã‚¨ãƒ©ãƒ¼: ç§»å‹•å…ˆ VC ãŒä¸è¶³ã—ãŸãŸã‚æ®‹ã‚Šã‚’ã‚¹ã‚­ãƒƒãƒ—ã€‚")
            break

        vc = guild.get_channel(VOICE_CHANNEL_IDS[current_match_channel_index])
        if not isinstance(vc, discord.VoiceChannel):
            logs.append(f"è­¦å‘Š: VC {VOICE_CHANNEL_IDS[current_match_channel_index]} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
            continue

        claimer_id = claimed_messages[fwd_id]
        pairs.append({
            "orig_id": o_id, "fwd_id": fwd_id, "dest_id": dest_id,
            "author_id": author_id, "claimer_id": claimer_id, "vc": vc
        })
        need_ids.update((author_id, claimer_id))
        current_match_channel_index += 1

    # ---- 2. ãƒ¡ãƒ³ãƒãƒ¼ä¸€æ‹¬å–å¾— -----------------------------------------
    cache: dict[int, discord.Member] = {}
    if need_ids:
        try:
            members = await guild.query_members(limit=None, user_ids=list(need_ids)).flatten()
            cache = {m.id: m for m in members}
        except AttributeError:             # ã•ã‚‰ã«å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¯¾ç­–
            for uid in need_ids:
                try:
                    cache[uid] = await guild.fetch_member(uid)
                except discord.NotFound:
                    pass
                except Exception as e:
                    logs.append(f"fetch_member å¤±æ•— ({uid}): {e}")
        except Exception as e:
            await interaction.followup.send(f"ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {e}", ephemeral=True)
            return

    # ---- 3. ãƒšã‚¢ã”ã¨ã®å‡¦ç† -------------------------------------------
    async def handle(pair: dict) -> tuple[bool, str]:
        fwd   = pair["fwd_id"]
        dest  = pair["dest_id"]
        a_id  = pair["author_id"]
        c_id  = pair["claimer_id"]
        vc    = pair["vc"]

        try:
            m1 = cache.get(a_id); m2 = cache.get(c_id)
            if not m1 or not m2:
                return False, f"ãƒ¡ãƒ³ãƒãƒ¼æœªå–å¾— (Fwd:{fwd})"

            for m in (m1, m2):
                if not (m.voice and m.voice.channel and m.voice.channel.id == WAITING_VOICE_CHANNEL_ID):
                    return False, f"{m.display_name} ãŒå¾…æ©Ÿ VC ã«ã„ã¾ã›ã‚“"

            await asyncio.gather(m1.move_to(vc), m2.move_to(vc))

            txt = guild.get_channel(dest)
            if isinstance(txt, discord.TextChannel):
                msg = await txt.fetch_message(fwd)
                if msg.embeds:
                    emb = msg.embeds[0].copy()
                    idx = {f.name: i for i, f in enumerate(emb.fields)}
                    status = f"âœ… ç§»å‹•å®Œäº† ({vc.mention})"
                    emb.set_field_at(idx.get("çŠ¶æ…‹", len(emb.fields)),
                                     name="çŠ¶æ…‹", value=status, inline=False,
                                     insert=True)
                    emb.set_field_at(idx.get("å›ç­”è€…", len(emb.fields)),
                                     name="å›ç­”è€…", value=m1.mention, inline=False,
                                     insert=True)
                    await msg.edit(embed=emb)
            return True, str(fwd)
        except Exception as e:
            return False, f"å‡¦ç†ã‚¨ãƒ©ãƒ¼ (Fwd:{fwd}): {e}"

    ok_cnt = 0
    for ok, note in await asyncio.gather(*(handle(p) for p in pairs)):
        if ok:
            ok_cnt += 1
            matched_pairs.add(int(note))
        else:
            logs.append(f"è­¦å‘Š: {note}")

    # ---- 4. å¾Œç‰‡ä»˜ã‘ ---------------------------------------------------
    processed_oids  = {p["orig_id"] for p in pairs if p["fwd_id"] in matched_pairs}
    processed_cids  = {p["claimer_id"] for p in pairs if p["fwd_id"] in matched_pairs}

    for oid in processed_oids:
        message_map.pop(oid, None)
    for fid in matched_pairs:
        claimed_messages.pop(fid, None)
        active_claimable_messages.discard(fid)

    users_who_claimed_this_round -= processed_cids
    matched_pairs.clear()
    current_match_channel_index = 0
    last_non_winner_message_boys_id = None
    last_non_winner_message_girls_id = None

    # ---- 5. æœªå½“é¸è€…ãƒªã‚¹ãƒˆæ›´æ–° ----------------------------------------
    try:
        boys, girls, errs = await calculate_non_winner_content(guild)
        logs.extend(errs)
        if target_channel_boys:
            new, err = await post_list_message(target_channel_boys, boys, last_non_winner_message_boys_id)
            if new: last_non_winner_message_boys_id = new
            logs.extend(err)
        if target_channel_girls:
            new, err = await post_list_message(target_channel_girls, girls, last_non_winner_message_girls_id)
            if new: last_non_winner_message_girls_id = new
            logs.extend(err)
    except Exception as e:
        logs.append(f"æœªå½“é¸è€…ãƒªã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")

    # ---- 6. è¿”ä¿¡ -------------------------------------------------------
    msg = f"ãƒšã‚¢ç§»å‹• {ok_cnt} çµ„å®Œäº†ã€‚"
    if logs:
        msg += "\nã‚¨ãƒ©ãƒ¼/è­¦å‘Š:\n" + "\n".join(f"- {l}" for l in logs)
    else:
        msg += "\nçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆãƒ»ãƒªã‚¹ãƒˆæ›´æ–°å®Œäº†ã€‚"
    await interaction.followup.send(msg, ephemeral=True)



@bot.tree.command(name="reset-reactions", description="ã™ã¹ã¦ã®é¸æŠè‚¢ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€æœªé¸æŠã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚")
@app_commands.check(allowed_role_check)
async def reset_all_reactions(interaction: discord.Interaction):
    """
    ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå…¨ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã€‚
    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‰Šé™¤ã›ãšã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨å†…éƒ¨çŠ¶æ…‹ã®ã¿ã‚’åˆæœŸåŒ–ã™ã‚‹ã€‚
    """
    global claimed_messages, users_who_claimed_this_round, active_claimable_messages
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id

    await interaction.response.defer(ephemeral=True)

    guild = interaction.guild
    if not guild:
        await interaction.followup.send("ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", ephemeral=True)
        return

    if not message_map:
        await interaction.followup.send("ãƒªã‚»ãƒƒãƒˆå¯¾è±¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
        return

    error_log = []
    success_count = 0

    async def reset_one_message(fwd_id: int, dest_id: int):
        try:
            channel = guild.get_channel(dest_id)
            if not channel or not isinstance(channel, discord.TextChannel):
                return (False, f"ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (ID: {dest_id})")
            
            message = await channel.fetch_message(fwd_id)
            await message.clear_reactions()
            await message.add_reaction('ğŸ‘')
            
            if message.embeds:
                new_embed = message.embeds[0].copy()
                for i, field in enumerate(new_embed.fields):
                    if field.name == "é¸æŠè€…":
                        new_embed.set_field_at(i, name="é¸æŠè€…", value="ãªã—", inline=False)
                        await message.edit(embed=new_embed)
                        break
            return (True, f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ {fwd_id} ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚")
        except discord.NotFound:
            return (False, f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (ID: {fwd_id})")
        except Exception as e:
            return (False, f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ {fwd_id} ã®ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")

    tasks = [reset_one_message(fwd_id, dest_id) for _, (fwd_id, dest_id, _) in message_map.items()]
    results = await asyncio.gather(*tasks)

    for success, message in results:
        if success:
            success_count += 1
        else:
            error_log.append(message)
    
    active_claimable_messages.clear()
    active_claimable_messages.update([val[0] for val in message_map.values()])
    claimed_messages.clear()
    users_who_claimed_this_round.clear()

    try:
        content_boys, content_girls, calc_errors = await calculate_non_winner_content(guild)
        error_log.extend(calc_errors)

        if target_channel_boys:
            new_id, post_errs = await post_list_message(target_channel_boys, content_boys, last_non_winner_message_boys_id)
            if new_id: last_non_winner_message_boys_id = new_id
            error_log.extend(post_errs)

        if target_channel_girls:
            new_id, post_errs = await post_list_message(target_channel_girls, content_girls, last_non_winner_message_girls_id)
            if new_id: last_non_winner_message_girls_id = new_id
            error_log.extend(post_errs)
            
    except Exception as e:
        error_log.append(f"æœªå½“é¸è€…ãƒªã‚¹ãƒˆã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

    response_message = f"{success_count}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"
    if error_log:
        error_summary = "\n".join(f"- {err}" for err in error_log)
        response_message += f"\n\nä»¥ä¸‹ã®è­¦å‘ŠãŒã‚ã‚Šã¾ã™:\n{error_summary}"

    await interaction.followup.send(response_message, ephemeral=True)

@bot.tree.command(name="reset", description="ã™ã¹ã¦ã®çŠ¶æ…‹ã‚’å¼·åˆ¶çš„ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å‰Šé™¤ï¼‰")
@app_commands.check(allowed_role_check)
async def reset_command(interaction: discord.Interaction):
    global forwarded_message_ids, message_map, active_claimable_messages, claimed_messages, users_who_claimed_this_round, matched_pairs, current_match_channel_index, last_non_winner_message_boys_id, last_non_winner_message_girls_id, source_channel_girls, source_channel_boys
    await interaction.response.defer(ephemeral=True)
    error_messages_list = []
    guild = interaction.guild
    if not guild:
        await interaction.followup.send("ã‚µãƒ¼ãƒãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼", ephemeral=True)
        return
        
    try:
        tasks = []
        for _, (fwd_id, dest_id, _) in list(message_map.items()):
            channel = bot.get_channel(dest_id)
            if channel and isinstance(channel, discord.TextChannel):
                async def delete_msg(ch, msg_id):
                    try:
                        await (await ch.fetch_message(msg_id)).delete()
                    except: pass
                tasks.append(delete_msg(channel, fwd_id))
        await asyncio.gather(*tasks)
    except Exception as e:
        error_messages_list.append(f"ä¸€æ‹¬å‰Šé™¤ä¸­ã‚¨ãƒ©ãƒ¼: {e}")
        
    try:
        if source_channel_girls and source_channel_boys:
            forwarded_message_ids = {source_channel_girls.id: set(), source_channel_boys.id: set()}
        else:
            forwarded_message_ids = {}
        message_map.clear()
        active_claimable_messages.clear()
        claimed_messages.clear()
        users_who_claimed_this_round.clear()
        matched_pairs.clear()
        current_match_channel_index = 0
        last_non_winner_message_boys_id = None
        last_non_winner_message_girls_id = None
    except Exception as e:
        error_messages_list.append(f"çŠ¶æ…‹åˆæœŸåŒ–ä¸­ã‚¨ãƒ©ãƒ¼: {e}")
        
    if error_messages_list:
        result_msg = "ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼ˆè­¦å‘Šã‚ã‚Šï¼‰:\n" + "\n".join(f"- {m}" for m in error_messages_list)
    else:
        result_msg = "ã™ã¹ã¦ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"
    await interaction.followup.send(result_msg, ephemeral=True)

# --- Bot Execution ---
if TOKEN:
    try:
        print("Botèµ·å‹•ä¸­...")
        bot.run(TOKEN)
    except discord.LoginFailure:
        print("ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ©ãƒ¼")
    except Exception as e:
        print(f"èµ·å‹•ã‚¨ãƒ©ãƒ¼: {e}")
else:
    print("DISCORD_TOKEN æœªè¨­å®š")

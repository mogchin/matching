import discord
from discord.ext import commands
from discord import app_commands
import os
import random
from dotenv import load_dotenv
import asyncio
import datetime
from typing import Dict, Set, Tuple, List

# --- Environment Variables ---
load_dotenv()
TOKEN = os.getenv('DISCORD_TOKEN')

# --- Configuration ---
SOURCE_CHANNEL_GIRLS_NAME = "å¥³å­å›ç­”"
SOURCE_CHANNEL_BOYS_NAME = "ç”·å­å›ç­”"
TARGET_CHANNEL_GIRLS_NAME = "å¥³å­é¸æŠ"
TARGET_CHANNEL_BOYS_NAME = "ç”·å­é¸æŠ"

# Role IDs for users allowed to react/select
ALLOWED_ROLE_IDS: Set[int] = {
    1106457108070801449,  # ä¾‹: ç”·å­ç”¨ãƒ­ãƒ¼ãƒ«ID
    1304664940019187762   # ä¾‹: å¥³å­ç”¨ãƒ­ãƒ¼ãƒ«ID
}

# Role ID allowed to execute /send1, /match, /reset etc.
EXECUTE_ROLE_ID = 991112832655560825  # ä¾‹: ç®¡ç†è€…ç”¨å½¹è·ID

# Voice Channel IDs for matched pairs
VOICE_CHANNEL_IDS = [
    861209035901501451, 921389966939000842, 861209625353650176, 1144961582158315601,
    1346803272094191616, 1144961845891969086, 1346803325705916470, 1030459649952055326,
    861209735826898954, 889128948225679410, 1124346578522607667, 1076820944896675931,
    1129391099354546249, 1129391139905097768, 1165525003165515847, 1165611161887191070,
    1165525074317676615, 1165606798577901648, 1165606801547464765, 1165606820178567220,
    1165606757788307506, 1238860655683960853,
]

# Waiting Voice Channel ID (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã™ã‚‹éš›ã®å¾…æ©ŸVC)
WAITING_VOICE_CHANNEL_ID = 1059809361645551746

# --- Bot Setup ---
intents = discord.Intents.default()
intents.messages = True
intents.guilds = True
intents.message_content = True
intents.reactions = True
intents.members = True

bot = commands.Bot(command_prefix="!", intents=intents)

# --- Global State Variables ---
source_channel_girls: discord.TextChannel = None
source_channel_boys: discord.TextChannel = None
target_channel_girls: discord.TextChannel = None
target_channel_boys: discord.TextChannel = None
forwarded_message_ids: Dict[int, Set[int]] = {}
message_map: Dict[int, Tuple[int, int, int]] = {}  # {original_message_id: (forwarded_message_id, destination_channel_id, original_author_id)}
active_claimable_messages: Set[int] = set()
claimed_messages: Dict[int, int] = {}  # {forwarded_message_id: claimer_id}
users_who_claimed_this_round: Set[int] = set()
matched_pairs: Set[int] = set()
current_match_channel_index: int = 0
bot_start_time: datetime.datetime = None
last_non_winner_message_boys_id: int = None
last_non_winner_message_girls_id: int = None

# --- Custom Check ---
def allowed_role_check(interaction: discord.Interaction) -> bool:
    """EXECUTE_ROLE_IDã‚’æŒã¤äººã®ã¿å®Ÿè¡Œå¯"""
    return any(role.id == EXECUTE_ROLE_ID for role in interaction.user.roles)

# ------------------------------------------------------
# â˜…â˜…â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆâ˜…â˜…â˜…
# æœªå½“é¸è€…ãƒªã‚¹ãƒˆã‚’ã€Œå‰Šé™¤â†’æ–°è¦æŠ•ç¨¿ã€ã§ã¯ãªã
# ã€Œæ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ç·¨é›†ã€ãªã‘ã‚Œã°æ–°è¦æŠ•ç¨¿ã€ã™ã‚‹é–¢æ•°ã«å¤‰æ›´
# ------------------------------------------------------
async def post_list_message(channel: discord.TextChannel, content: str, old_message_id: int) -> Tuple[int, List[str]]:
    """
    æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã—ã€å­˜åœ¨ã—ãªã‘ã‚Œã°æ–°è¦é€ä¿¡ã™ã‚‹ã€‚
    æˆ»ã‚Šå€¤: (æœ€çµ‚çš„ã«å­˜åœ¨ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID, ã‚¨ãƒ©ãƒ¼ãƒªã‚¹ãƒˆ)
    """
    errors = []
    new_message_id = None
    if not channel:
        errors.append("ã‚¨ãƒ©ãƒ¼: å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return None, errors

    # 1) old_message_id ãŒã‚ã‚Œã°ç·¨é›†ã‚’è©¦ã¿ã‚‹
    if old_message_id:
        try:
            old_msg = await channel.fetch_message(old_message_id)
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç·¨é›†
            await old_msg.edit(content=content)
            new_message_id = old_msg.id
            return new_message_id, errors  # ç·¨é›†æˆåŠŸãªã®ã§çµ‚äº†
        except discord.NotFound:
            # å­˜åœ¨ã—ãªã‹ã£ãŸå ´åˆã¯æ–°è¦é€ä¿¡ã¸
            pass
        except discord.Forbidden:
            errors.append(f"è­¦å‘Š: ãƒãƒ£ãƒ³ãƒãƒ« '{channel.name}' ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        except Exception as e:
            errors.append(f"ç·¨é›†æ™‚ã‚¨ãƒ©ãƒ¼({channel.name}): {e}")

    # 2) æ–°è¦é€ä¿¡
    try:
        sent_msg = await channel.send(content)
        new_message_id = sent_msg.id
    except discord.Forbidden:
        errors.append(f"ã‚¨ãƒ©ãƒ¼: ãƒãƒ£ãƒ³ãƒãƒ« '{channel.name}' ã¸ã®é€ä¿¡æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
    except Exception as e:
        errors.append(f"é€ä¿¡æ™‚ã‚¨ãƒ©ãƒ¼({channel.name}): {e}")

    return new_message_id, errors

# --- Calculate Non-Winner List Content ---
async def calculate_non_winner_content(guild: discord.Guild) -> Tuple[str, str, List[str]]:
    """
    æœªå½“é¸è€…ãƒªã‚¹ãƒˆã®å†…å®¹ã‚’è¨ˆç®—ã™ã‚‹ã€‚
    ã€Œæœªå½“é¸ã€ã‹ã¤ã€Œå¾…æ©ŸVCã«æ¥ç¶šã—ã¦ã„ã‚‹ã€ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿è¡¨ç¤ºã€‚
    """
    global target_channel_boys, target_channel_girls, message_map, claimed_messages
    calc_errors: List[str] = []

    role_girls_id = 1304664940019187762  # å¥³å­ç”¨ãƒ­ãƒ¼ãƒ«ID
    role_boys_id = 1106457108070801449   # ç”·å­ç”¨ãƒ­ãƒ¼ãƒ«ID

    role_girls = guild.get_role(role_girls_id)
    role_boys = guild.get_role(role_boys_id)

    winners_girls = set()
    winners_boys = set()

    # å½“é¸æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚»ãƒƒãƒˆã«å…¥ã‚Œã‚‹
    for fwd_id, claimer_id in claimed_messages.items():
        original_author_id = None
        dest_channel_id = None
        found = False
        for _orig_id, (fwd_id_map, dest_channel_id_map, original_author_id_map) in message_map.items():
            if fwd_id_map == fwd_id:
                original_author_id = original_author_id_map
                dest_channel_id = dest_channel_id_map
                found = True
                break
        if not found:
            calc_errors.append(f"è»¢é€ID {fwd_id} ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
            continue

        if target_channel_boys and dest_channel_id == target_channel_boys.id:
            winners_boys.add(claimer_id)
            winners_girls.add(original_author_id)
        elif target_channel_girls and dest_channel_id == target_channel_girls.id:
            winners_girls.add(claimer_id)
            winners_boys.add(original_author_id)
        else:
            calc_errors.append(f"è»¢é€å…ˆãƒãƒ£ãƒ³ãƒãƒ«ID {dest_channel_id} ãŒä¸æ˜ã§ã™ã€‚")

    # ç”·å­ã®æœªå½“é¸è€…(ã‹ã¤å¾…æ©ŸVCæ¥ç¶šä¸­)
    non_winners_boys = []
    if role_boys:
        for m in role_boys.members:
            if (m.id not in winners_boys
                and m.voice
                and m.voice.channel
                and m.voice.channel.id == WAITING_VOICE_CHANNEL_ID):
                non_winners_boys.append(m.mention)

    # å¥³å­ã®æœªå½“é¸è€…(ã‹ã¤å¾…æ©ŸVCæ¥ç¶šä¸­)
    non_winners_girls = []
    if role_girls:
        for m in role_girls.members:
            if (m.id not in winners_girls
                and m.voice
                and m.voice.channel
                and m.voice.channel.id == WAITING_VOICE_CHANNEL_ID):
                non_winners_girls.append(m.mention)

    content_boys = "ã€ç”·å­ æœªå½“é¸è€…ä¸€è¦§ã€‘\n" + (", ".join(non_winners_boys) if non_winners_boys else "ãªã—")
    content_girls = "ã€å¥³å­ æœªå½“é¸è€…ä¸€è¦§ã€‘\n" + (", ".join(non_winners_girls) if non_winners_girls else "ãªã—")

    return content_boys, content_girls, calc_errors

@bot.event
async def on_ready():
    global source_channel_girls, source_channel_boys
    global target_channel_girls, target_channel_boys
    global forwarded_message_ids, bot_start_time

    print(f'{bot.user.name} ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ (ID: {bot.user.id})')
    bot_start_time = datetime.datetime.now(datetime.timezone.utc)

    try:
        synced = await bot.tree.sync()
        print(f"{len(synced)}å€‹ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’åŒæœŸã—ã¾ã—ãŸã€‚")
    except Exception as e:
        print(f"ã‚³ãƒãƒ³ãƒ‰åŒæœŸã‚¨ãƒ©ãƒ¼: {e}")

    if not bot.guilds:
        print("ã‚¨ãƒ©ãƒ¼: å‚åŠ ã‚µãƒ¼ãƒãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        await bot.close()
        return

    guild = bot.guilds[0]
    source_channel_girls = discord.utils.get(guild.text_channels, name=SOURCE_CHANNEL_GIRLS_NAME)
    source_channel_boys = discord.utils.get(guild.text_channels, name=SOURCE_CHANNEL_BOYS_NAME)
    target_channel_girls = discord.utils.get(guild.text_channels, name=TARGET_CHANNEL_GIRLS_NAME)
    target_channel_boys = discord.utils.get(guild.text_channels, name=TARGET_CHANNEL_BOYS_NAME)

    if not all([source_channel_girls, source_channel_boys, target_channel_girls, target_channel_boys]):
        print("å¿…è¦ãªãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    else:
        forwarded_message_ids = {
            source_channel_girls.id: set(),
            source_channel_boys.id: set()
        }
    print("Botæº–å‚™å®Œäº†ã€‚")

@bot.event
async def on_message_edit(before: discord.Message, after: discord.Message):
    """
    è»¢é€å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç·¨é›†ã•ã‚ŒãŸå ´åˆã€è»¢é€å…ˆã‚‚åŒæ§˜ã«ç·¨é›†ã™ã‚‹ã€‚
    â€» claimed_messages ã‹ã©ã†ã‹ã«é–¢ã‚ã‚‰ãšå¸¸ã«æ›´æ–°
    """
    if before.author.bot or before.id not in message_map:
        return

    forwarded_message_id, destination_channel_id, _ = message_map[before.id]
    destination_channel = bot.get_channel(destination_channel_id)
    if not destination_channel or not isinstance(destination_channel, discord.TextChannel):
        return

    try:
        f_msg = await destination_channel.fetch_message(forwarded_message_id)
    except discord.NotFound:
        # è»¢é€å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ—¢ã«æ¶ˆã•ã‚Œã¦ã„ã‚‹å ´åˆãªã©
        return
    except Exception as e:
        print(f"[on_message_edit] è»¢é€å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return

    new_content = after.content if after.content else "(æœ¬æ–‡ãªã—)"
    try:
        if f_msg.embeds:
            new_embed = f_msg.embeds[0].copy()
            new_embed.description = new_content
            await f_msg.edit(embed=new_embed)
        else:
            await f_msg.edit(content=new_content)
    except Exception as e:
        print(f"[on_message_edit] è»¢é€å…ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")


@bot.event
async def on_message_delete(message: discord.Message):
    """
    è»¢é€å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‰Šé™¤ã•ã‚ŒãŸã‚‰ã€è»¢é€å…ˆã‚‚å‰Šé™¤ã™ã‚‹ã€‚
    """
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id

    if message.author.bot or message.id not in message_map:
        return

    # è»¢é€å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æƒ…å ±ã‚’å–å¾—ã—ã¦å‰Šé™¤
    forwarded_message_id, destination_channel_id, _ = message_map.pop(message.id)
    destination_channel = bot.get_channel(destination_channel_id)

    active_claimable_messages.discard(forwarded_message_id)
    if forwarded_message_id in claimed_messages:
        claimer_id = claimed_messages.pop(forwarded_message_id)
        users_who_claimed_this_round.discard(claimer_id)
        matched_pairs.discard(forwarded_message_id)

    if destination_channel and isinstance(destination_channel, discord.TextChannel):
        try:
            f_msg = await destination_channel.fetch_message(forwarded_message_id)
            await f_msg.delete()
        except discord.NotFound:
            pass
        except Exception as e:
            print(f"[on_message_delete] è»¢é€å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã‚¨ãƒ©ãƒ¼: {e}")

    # æœªå½“é¸è€…ãƒªã‚¹ãƒˆå†æ²
    try:
        if message.guild:
            content_boys, content_girls, calc_errors = await calculate_non_winner_content(message.guild)
            if calc_errors:
                for err in calc_errors:
                    print(f"[on_message_delete] ãƒªã‚¹ãƒˆæ›´æ–°è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {err}")

            if target_channel_boys and any(v[1] == target_channel_boys.id for v in message_map.values()):
                new_id, errors = await post_list_message(target_channel_boys, content_boys, last_non_winner_message_boys_id)
                if new_id:
                    last_non_winner_message_boys_id = new_id
                for err in errors:
                    print(f"[on_message_delete] ç”·å­æœªå½“é¸ãƒªã‚¹ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: {err}")

            if target_channel_girls and any(v[1] == target_channel_girls.id for v in message_map.values()):
                new_id, errors = await post_list_message(target_channel_girls, content_girls, last_non_winner_message_girls_id)
                if new_id:
                    last_non_winner_message_girls_id = new_id
                for err in errors:
                    print(f"[on_message_delete] å¥³å­æœªå½“é¸ãƒªã‚¹ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: {err}")

    except Exception as e:
        print(f"[on_message_delete] æœªå½“é¸è€…ãƒªã‚¹ãƒˆå†æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")

@bot.event
async def on_raw_reaction_add(payload: discord.RawReactionActionEvent):
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id
    if payload.user_id == bot.user.id or str(payload.emoji) != 'ğŸ‘':
        return

    guild = bot.get_guild(payload.guild_id)
    if not guild:
        return
    channel = guild.get_channel(payload.channel_id)
    if not isinstance(channel, discord.TextChannel):
        return

    try:
        message = await channel.fetch_message(payload.message_id)
    except Exception as e:
        print(f"ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        return

    member = payload.member or (await guild.fetch_member(payload.user_id))
    if payload.message_id not in active_claimable_messages:
        return

    # æ¡ä»¶ã‚’æº€ãŸã•ãªã„å ´åˆã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é™¤å»ã—ã¦çµ‚äº†
    if (
        payload.message_id in claimed_messages or
        payload.user_id in users_who_claimed_this_round or
        not (member.voice and member.voice.channel and member.voice.channel.id == WAITING_VOICE_CHANNEL_ID) or
        not any(role.id in ALLOWED_ROLE_IDS for role in member.roles)
    ):
        try:
            await message.remove_reaction(payload.emoji, member)
        except:
            pass
        return

    # Claim
    claimed_messages[payload.message_id] = payload.user_id
    users_who_claimed_this_round.add(payload.user_id)
    active_claimable_messages.remove(payload.message_id)

    try:
        await message.clear_reaction('ğŸ‘')
        await message.add_reaction('âœ…')
        if message.embeds:
            new_embed = message.embeds[0].copy()
            selector_index = -1
            for i, field in enumerate(new_embed.fields):
                if field.name == "é¸æŠè€…":
                    selector_index = i
                    break
            if selector_index != -1:
                new_embed.set_field_at(selector_index, name="é¸æŠè€…", value=f"âœ… {member.mention}", inline=False)
            else:
                new_embed.add_field(name="é¸æŠè€…", value=f"âœ… {member.mention}", inline=False)
            await message.edit(embed=new_embed)
        else:
            await message.edit(content=message.content + f"\nâœ… {member.mention} ã•ã‚“ãŒé¸æŠã—ã¾ã—ãŸï¼")

        # æœªå½“é¸è€…ãƒªã‚¹ãƒˆæ›´æ–°
        content_boys, content_girls, calc_errors = await calculate_non_winner_content(guild)
        if calc_errors:
            print(f"ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ãƒªã‚¹ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼: {calc_errors}")

        if target_channel_boys and any(v[1] == target_channel_boys.id for v in message_map.values()):
            new_id, errors = await post_list_message(target_channel_boys, content_boys, last_non_winner_message_boys_id)
            if new_id:
                last_non_winner_message_boys_id = new_id

        if target_channel_girls and any(v[1] == target_channel_girls.id for v in message_map.values()):
            new_id, errors = await post_list_message(target_channel_girls, content_girls, last_non_winner_message_girls_id)
            if new_id:
                last_non_winner_message_girls_id = new_id

    except Exception as e:
        print(f"ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼: {e}")
        # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
        claimed_messages.pop(payload.message_id, None)
        users_who_claimed_this_round.discard(payload.user_id)
        active_claimable_messages.add(payload.message_id)

@bot.tree.command(name="send1", description="å›ç­”ã‚’è»¢é€ã—ã€æœªå½“é¸è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°")
@app_commands.check(allowed_role_check)
async def send_messages(interaction: discord.Interaction):
    global forwarded_message_ids, message_map, active_claimable_messages
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id

    if not all([source_channel_girls, source_channel_boys, target_channel_girls, target_channel_boys]):
        await interaction.response.send_message("ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªãƒãƒ£ãƒ³ãƒãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", ephemeral=True)
        return

    await interaction.response.defer(ephemeral=True)
    total_forwarded_count = 0
    error_messages_list: List[str] = []

    async def process_channel(source_channel: discord.TextChannel,
                              target_channel: discord.TextChannel,
                              embed_color: discord.Color) -> int:
        nonlocal total_forwarded_count
        count = 0
        try:
            source_messages = []
            async for msg in source_channel.history(limit=None, after=bot_start_time):
                if (not msg.author.bot and
                    msg.id not in forwarded_message_ids.get(source_channel.id, set()) and
                    msg.id not in message_map and (msg.content or msg.attachments)):
                    source_messages.append(msg)

            random.shuffle(source_messages)
            for orig_msg in source_messages:
                try:
                    embed = discord.Embed(
                        description=orig_msg.content if orig_msg.content else "(æœ¬æ–‡ãªã—)",
                        color=embed_color,
                        timestamp=orig_msg.created_at
                    )

                    image_url = None
                    for att in orig_msg.attachments:
                        if att.content_type and att.content_type.startswith('image/'):
                            image_url = att.url
                            break
                    if image_url:
                        embed.set_image(url=image_url)

                    others = [att.filename for att in orig_msg.attachments if att.url != image_url]
                    if others:
                        embed.add_field(name="æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«", value="\n".join(f"- {name}" for name in others), inline=False)

                    embed.add_field(name="é¸æŠè€…", value="ãªã—", inline=False)

                    fwd_msg = await target_channel.send(embed=embed)
                    await fwd_msg.add_reaction("ğŸ‘")

                    forwarded_message_ids[source_channel.id].add(orig_msg.id)
                    message_map[orig_msg.id] = (fwd_msg.id, target_channel.id, orig_msg.author.id)
                    active_claimable_messages.add(fwd_msg.id)
                    count += 1
                    await asyncio.sleep(0.5)
                except Exception as e:
                    error_messages_list.append(f"è»¢é€ä¸­ã‚¨ãƒ©ãƒ¼ (ID:{orig_msg.id}): {e}")
            return count

        except Exception as e:
            error_messages_list.append(f"{source_channel.name} å‡¦ç†ä¸­ã‚¨ãƒ©ãƒ¼: {e}")
            return count

    # å¥³å­å›ç­” -> ç”·å­é¸æŠ (color=fuchsia)
    count_g = await process_channel(source_channel_girls, target_channel_boys, discord.Color.fuchsia())
    # ç”·å­å›ç­” -> å¥³å­é¸æŠ (color=blue)
    count_b = await process_channel(source_channel_boys, target_channel_girls, discord.Color.blue())
    total_forwarded_count = count_g + count_b

    if total_forwarded_count > 0 and interaction.guild:
        content_boys, content_girls, calc_errors = await calculate_non_winner_content(interaction.guild)
        error_messages_list.extend(calc_errors)

        if target_channel_boys and any(v[1] == target_channel_boys.id for v in message_map.values()):
            new_id, post_err = await post_list_message(target_channel_boys, content_boys, last_non_winner_message_boys_id)
            if new_id:
                last_non_winner_message_boys_id = new_id
            error_messages_list.extend(post_err)

        if target_channel_girls and any(v[1] == target_channel_girls.id for v in message_map.values()):
            new_id, post_err = await post_list_message(target_channel_girls, content_girls, last_non_winner_message_girls_id)
            if new_id:
                last_non_winner_message_girls_id = new_id
            error_messages_list.extend(post_err)
    else:
        print("è»¢é€ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ0ä»¶ã®ãŸã‚ã€æœªå½“é¸è€…ãƒªã‚¹ãƒˆã®æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")

    result_msg = f"åˆè¨ˆ {total_forwarded_count} ä»¶ã®æ–°è¦è»¢é€å®Œäº†ã€‚"
    if error_messages_list:
        result_msg += "\nã‚¨ãƒ©ãƒ¼/è­¦å‘Š:\n" + "\n".join(f"{i+1}. {msg}" for i, msg in enumerate(error_messages_list))
    else:
        result_msg += "\næœªå½“é¸è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚"

    await interaction.followup.send(result_msg, ephemeral=True)


@bot.tree.command(name="match", description="ãƒšã‚¢ç§»å‹•ï¼†çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼†ãƒªã‚¹ãƒˆæ›´æ–°")
@app_commands.check(allowed_role_check)
async def match_all(interaction: discord.Interaction):
    global current_match_channel_index, matched_pairs
    global forwarded_message_ids, message_map, active_claimable_messages
    global claimed_messages, users_who_claimed_this_round
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id
    global source_channel_girls, source_channel_boys, target_channel_boys, target_channel_girls

    await interaction.response.defer(ephemeral=True)
    moved_count = 0
    error_messages_list: List[str] = []

    guild = interaction.guild
    if not guild:
        await interaction.followup.send("ã‚µãƒ¼ãƒãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼", ephemeral=True)
        return

    items = list(message_map.items())
    for orig_id, (fwd_id, dest_id, orig_author_id) in items:
        # æœªé¸æŠ or æ—¢ã«matchæ¸ˆã¿ã®ã‚‚ã®ã¯ã‚¹ã‚­ãƒƒãƒ—
        if fwd_id not in claimed_messages or fwd_id in matched_pairs:
            continue

        claimer_id = claimed_messages[fwd_id]
        pair_boy = None
        pair_girl = None
        target_txt = guild.get_channel(dest_id)

        # ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’è¦‹ã¦æŠ•ç¨¿è€…ã‚’ç”·å¥³åˆ¤å®š
        try:
            if target_txt and dest_id == target_channel_boys.id:
                pair_girl = await guild.fetch_member(orig_author_id)
                pair_boy = await guild.fetch_member(claimer_id)
            elif target_txt and dest_id == target_channel_girls.id:
                pair_boy = await guild.fetch_member(orig_author_id)
                pair_girl = await guild.fetch_member(claimer_id)
            else:
                continue
        except Exception as e:
            error_messages_list.append(f"ãƒšã‚¢å–å¾—ã‚¨ãƒ©ãƒ¼ (origMsgID:{orig_id}): {e}")
            continue

        # å¾…æ©ŸVCã«ã„ãªã„ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
        if not (pair_boy and pair_boy.voice and pair_boy.voice.channel and pair_boy.voice.channel.id == WAITING_VOICE_CHANNEL_ID):
            error_messages_list.append(f"{pair_boy.display_name} å¾…æ©ŸVCæœªåœ¨ä¸­ (origMsgID:{orig_id})")
            continue
        if not (pair_girl and pair_girl.voice and pair_girl.voice.channel and pair_girl.voice.channel.id == WAITING_VOICE_CHANNEL_ID):
            error_messages_list.append(f"{pair_girl.display_name} å¾…æ©ŸVCæœªåœ¨ä¸­ (origMsgID:{orig_id})")
            continue

        # VCç§»å‹•
        if current_match_channel_index >= len(VOICE_CHANNEL_IDS):
            error_messages_list.append("åˆ©ç”¨å¯èƒ½ãªVCãŒè¶³ã‚Šã¾ã›ã‚“ã€‚")
            break

        target_vc = guild.get_channel(VOICE_CHANNEL_IDS[current_match_channel_index])
        if not target_vc or not isinstance(target_vc, discord.VoiceChannel):
            error_messages_list.append(f"ç§»å‹•å…ˆVCãŒä¸æ­£ (ID:{VOICE_CHANNEL_IDS[current_match_channel_index]})")
            continue

        try:
            await pair_boy.move_to(target_vc)
            await pair_girl.move_to(target_vc)
            matched_pairs.add(fwd_id)
            current_match_channel_index += 1
            moved_count += 1
        except Exception as e:
            error_messages_list.append(f"VCç§»å‹•ã‚¨ãƒ©ãƒ¼ ({target_vc.name}): {e}")
            continue

        # Embedæ›´æ–°(ã€ŒçŠ¶æ…‹ã€ã€Œå›ç­”è€…ã€ã‚’è¿½è¨˜)
        try:
            if target_txt:
                f_msg = await target_txt.fetch_message(fwd_id)
                if f_msg.embeds:
                    new_embed = f_msg.embeds[0].copy()
                    # çŠ¶æ…‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                    status_idx = -1
                    for i, field in enumerate(new_embed.fields):
                        if field.name == "çŠ¶æ…‹":
                            status_idx = i
                            break
                    status_val = f"âœ… ç§»å‹•å®Œäº† ({target_vc.mention})"
                    if status_idx != -1:
                        new_embed.set_field_at(status_idx, name="çŠ¶æ…‹", value=status_val, inline=False)
                    else:
                        new_embed.add_field(name="çŠ¶æ…‹", value=status_val, inline=False)

                    # å›ç­”è€…ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                    answerer_idx = -1
                    for i, field in enumerate(new_embed.fields):
                        if field.name == "å›ç­”è€…":
                            answerer_idx = i
                            break
                    if dest_id == target_channel_boys.id:
                        answerer_val = f"{pair_girl.mention}"
                    else:
                        answerer_val = f"{pair_boy.mention}"

                    if answerer_idx != -1:
                        new_embed.set_field_at(answerer_idx, name="å›ç­”è€…", value=answerer_val, inline=False)
                    else:
                        new_embed.add_field(name="å›ç­”è€…", value=answerer_val, inline=False)

                    await f_msg.edit(embed=new_embed)

        except Exception as e:
            error_messages_list.append(f"Embedæ›´æ–°è­¦å‘Š (FwdMsgID:{fwd_id}): {e}")

        await asyncio.sleep(0.5)

    # --- çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ ---
    try:
        forwarded_message_ids = {source_channel_girls.id: set(), source_channel_boys.id: set()}
        message_map.clear()
        active_claimable_messages.clear()
        claimed_messages.clear()
        users_who_claimed_this_round.clear()
        matched_pairs.clear()
        current_match_channel_index = 0
        last_non_winner_message_boys_id = None
        last_non_winner_message_girls_id = None
    except Exception as e:
        error_messages_list.append(f"çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼: {e}")

    # æœªå½“é¸è€…ãƒªã‚¹ãƒˆå†æ›´æ–°
    try:
        content_boys, content_girls, calc_errors = await calculate_non_winner_content(guild)
        error_messages_list.extend(calc_errors)

        if target_channel_boys and any(v[1] == target_channel_boys.id for v in message_map.values()):
            new_id, errs = await post_list_message(target_channel_boys, content_boys, last_non_winner_message_boys_id)
            if new_id:
                last_non_winner_message_boys_id = new_id
            error_messages_list.extend(errs)

        if target_channel_girls and any(v[1] == target_channel_girls.id for v in message_map.values()):
            new_id, errs = await post_list_message(target_channel_girls, content_girls, last_non_winner_message_girls_id)
            if new_id:
                last_non_winner_message_girls_id = new_id
            error_messages_list.extend(errs)

    except Exception as e:
        error_messages_list.append(f"ãƒªã‚¹ãƒˆæ›´æ–°å¾Œã‚¨ãƒ©ãƒ¼: {e}")

    resp = f"ãƒšã‚¢ç§»å‹• {moved_count} çµ„å®Œäº†ã€‚"
    if error_messages_list:
        resp += "\nã‚¨ãƒ©ãƒ¼/è­¦å‘Š:\n" + "\n".join(f"{i+1}. {msg}" for i, msg in enumerate(error_messages_list))
    else:
        resp += "\nçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆãƒ»ãƒªã‚¹ãƒˆæ›´æ–°å®Œäº†ã€‚"

    await interaction.followup.send(resp, ephemeral=True)


@bot.tree.command(name="reset", description="é€”ä¸­ã§ãƒˆãƒ©ãƒ–ãƒ«ãŒã‚ã£ãŸå ´åˆãªã©ã«ã€å¼·åˆ¶çš„ã«çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™")
@app_commands.check(allowed_role_check)
async def reset_command(interaction: discord.Interaction):
    """
    è»¢é€ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã€å†…éƒ¨ç®¡ç†ç”¨ã®çŠ¶æ…‹ã‚‚åˆæœŸåŒ–ã™ã‚‹ã€‚
    """
    # ã“ã“ã§ä½¿ã†ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å…ˆã«å®£è¨€
    global forwarded_message_ids, message_map, active_claimable_messages
    global claimed_messages, users_who_claimed_this_round, matched_pairs
    global current_match_channel_index
    global last_non_winner_message_boys_id, last_non_winner_message_girls_id
    global source_channel_girls, source_channel_boys

    await interaction.response.defer(ephemeral=True)

    error_messages_list: List[str] = []
    guild = interaction.guild
    if not guild:
        await interaction.followup.send("ã‚µãƒ¼ãƒãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼", ephemeral=True)
        return

    # 1) è»¢é€å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ‹¬å‰Šé™¤ï¼ˆä¸è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    try:
        for orig_id, (fwd_id, dest_id, _orig_author) in list(message_map.items()):
            channel = bot.get_channel(dest_id)
            if channel and isinstance(channel, discord.TextChannel):
                try:
                    msg = await channel.fetch_message(fwd_id)
                    await msg.delete()
                except discord.NotFound:
                    pass
                except Exception as e:
                    error_messages_list.append(f"è»¢é€å…ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã‚¨ãƒ©ãƒ¼ (ID:{fwd_id}): {e}")
    except Exception as e:
        error_messages_list.append(f"ä¸€æ‹¬å‰Šé™¤ä¸­ã‚¨ãƒ©ãƒ¼: {e}")

    # 2) å„ç¨®çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
    try:
        forwarded_message_ids = {
            source_channel_girls.id: set(),
            source_channel_boys.id: set()
        } if (source_channel_girls and source_channel_boys) else {}
        message_map.clear()
        active_claimable_messages.clear()
        claimed_messages.clear()
        users_who_claimed_this_round.clear()
        matched_pairs.clear()
        current_match_channel_index = 0
        last_non_winner_message_boys_id = None
        last_non_winner_message_girls_id = None
    except Exception as e:
        error_messages_list.append(f"çŠ¶æ…‹åˆæœŸåŒ–ä¸­ã‚¨ãƒ©ãƒ¼: {e}")

    # 3) æœ€çµ‚çµæœã‚’è¿”ä¿¡
    if error_messages_list:
        result_msg = "ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼ˆè­¦å‘Šã‚ã‚Šï¼‰:\n" + "\n".join(f"{i+1}. {m}" for i, m in enumerate(error_messages_list))
    else:
        result_msg = "ã™ã¹ã¦ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"

    await interaction.followup.send(result_msg, ephemeral=True)


# --- Bot Execution ---
if TOKEN:
    try:
        print("Botèµ·å‹•ä¸­...")
        bot.run(TOKEN)
    except discord.LoginFailure:
        print("ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ©ãƒ¼")
    except Exception as e:
        print(f"èµ·å‹•ã‚¨ãƒ©ãƒ¼: {e}")
else:
    print("DISCORD_TOKEN æœªè¨­å®š")
